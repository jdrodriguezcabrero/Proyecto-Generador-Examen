<!DOCTYPE html>
<html lang=es>

<head>
    <meta charset=utf-8>
    <title>Generador de Ex√°menes Avanzado</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description"
        content="Programa para generar ex√°menes con diversos tipos de preguntas, para imprimir y para Moodle">
    <meta name="keywords" content="ex√°men, Moodle, aleatorio, multirespuesta, verdadero/falso">
    <meta name="author" content="Juan Diego Rodr√≠guez Cabrero">
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìù</text></svg>">
    <script src="pyodide.js"></script>
<script src="pyodide.asm.js" type="text/javascript"></script>
<script src="pdf.min.js"></script>
<link rel="stylesheet" href="pico.min.css">




    <style>
        .center {
            text-align: center;
        }

        .hidden {
            display: none;
        }

        .question-types-container {
            margin-bottom: 1.5rem;
        }

        .question-type {
            margin-bottom: 1rem;
            padding: 1rem;
            border-radius: 0.5rem;
            background-color: #f9f9f9;
        }

        .step {
            margin-bottom: 2rem;
            padding: 1.5rem;
            border-radius: 0.5rem;
            border: 1px solid #e0e0e0;
        }

        .step-number {
            display: inline-block;
            width: 2rem;
            height: 2rem;
            line-height: 2rem;
            text-align: center;
            background-color: #1095c1;
            color: white;
            border-radius: 50%;
            margin-right: 0.5rem;
        }

        .nav-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1.5rem;
        }

        .nav-step {
            flex: 1;
            padding: 0.5rem;
            text-align: center;
            background-color: #f0f0f0;
            border-right: 1px solid white;
        }

        .nav-step.active {
            background-color: #1095c1;
            color: white;
        }

        button.outline {
            border: 1px solid #1095c1;
            background-color: transparent;
            color: #1095c1;
        }

        .navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 1rem;
        }

        .penalizacion-config {
            margin-top: 0.5rem;
            padding: 0.75rem;
            border-left: 3px solid #1095c1;
            background-color: #f0f8ff;
            margin-bottom: 1rem;
        }

        .penalizacion-config small {
            display: block;
            margin-top: 0.25rem;
            color: #666;
        }

        .penalizacion-config input[type="number"] {
            max-width: 100px;
        }

        #prompt-output {
            padding: 1rem;
            background-color: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }

        .copy-button {
            margin-top: 0.5rem;
            background-color: #1095c1;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
        }

        .copy-button:hover {
            background-color: #0d7ea5;
        }

        .file-info {
            margin-top: 0.5rem;
            font-size: 0.85rem;
            color: #666;
        }

        .panel-tabs {
            display: flex;
            margin-bottom: 1rem;
        }

        .panel-tab {
            padding: 0.5rem 1rem;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }

        .panel-tab.active {
            border-bottom: 2px solid #1095c1;
            color: #1095c1;
            font-weight: bold;
        }

        .panel-content {
            display: none;
        }

        .panel-content.active {
            display: block;
        }

        .opciones-modo {
            margin-top: 15px;
            padding: 15px;
            background-color: #f5f5f5;
            border-radius: 5px;
            border-left: 3px solid #1095c1;
        }

        .panel-tab {
            position: relative;
            cursor: pointer;
        }

        .panel-tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 100%;
            height: 2px;
            background-color: #1095c1;
        }

        #opciones-avanzadas-panel fieldset {
            margin-bottom: 1rem;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        #opciones-avanzadas-panel legend {
            font-weight: bold;
            padding: 0 0.5rem;
        }

        #opciones-avanzadas-panel small {
            display: block;
            margin-top: 0.25rem;
            color: #666;
        }


        #opciones-avanzadas-panel input[type="number"] {
            background-color: #f8f8f8;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 0.5rem;
        }

        #opciones-avanzadas-panel input[type="number"]:focus {
            border-color: #1095c1;
            box-shadow: 0 0 0 2px rgba(16, 149, 193, 0.2);
        }
        /* Color de fondo general y texto */
body {
    background-color: #006d38;
    color: #ffffff;
}

/* Secciones clave con fondo blanco y texto oscuro para buen contraste */
main, .step, .question-type, .opciones-modo, .penalizacion-config, #prompt-output {
    background-color: #ffffff;
    color: #000000;
    border-radius: 8px;
}

/* Botones primarios */
button,
button.primary,
button[type="submit"] {
    background-color: #00a64f;
    color: white;
    border: none;
    padding: 0.6rem 1.2rem;
    border-radius: 5px;
    cursor: pointer;
    font-weight: bold;
}

button:hover,
button.primary:hover,
button[type="submit"]:hover {
    background-color: #007f3a;
}

/* Botones de borde (outline) */
button.outline {
    background-color: transparent;
    border: 2px solid #00a64f;
    color: #00a64f;
    font-weight: bold;
}

button.outline:hover {
    background-color: #00a64f;
    color: white;
}

/* Enlaces */
a {
    color: #00cc66;
    font-weight: 500;
    text-decoration: underline;
}

a:hover {
    color: #00ff88;
}

/* Inputs con mejor contraste */
input, select, textarea {
    background-color: #ffffff;
    color: #000000;
    border: 1px solid #ccc;
    border-radius: 4px;
    padding: 0.5rem;
}

input:focus, select:focus, textarea:focus {
    border-color: #00a64f;
    box-shadow: 0 0 0 2px rgba(0, 166, 79, 0.25);
}
/* Encabezados sobre fondo oscuro (como el nav o body) */
body > h1, body > h2, header h1, header h2 {
    color: white;
}

/* Encabezados dentro de secciones claras (como .step, .question-type, etc.) */
.step h3, .step h4,
.question-type h4,
.opciones-modo h4,
.panel-content h4,
#step4 h3 {
    color: black;
}



/* Separadores con mejor integraci√≥n */
hr {
    border: none;
    border-top: 1px solid #ffffff33;
    margin: 2rem 0;
}

footer {
    background-color: transparent;
    color: #ffffff;
    font-weight: 500;
    font-size: 1rem;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
}



/* Enlaces m√°s refinados */
a {
    color: #7fffb2;
    text-decoration: underline;
}

a:hover {
    color: #afffd7;
}

/* Mejora de nav-step fondo claro en tema oscuro */
.nav-step {
    background-color: #e8f5ec;
    color: #000;
}

.nav-step.active {
    background-color: #00a64f;
    color: white;
}

√ß
.step h3, .step h4,
.question-type h4,
.opciones-modo h4,
.panel-content h4,
#step4 h3 {
    color: #000000;
}


    </style>
</head>

<body style="background-color: #006d38; color: white;">

<header style="text-align: center; padding: 10px; background-color: white;">
    <img src="logos/IES-Oretania_logo.jpg" alt="IES Oretania" style="height: 200px; margin-right: 20px;">
    <img src="logos/sinbad.png" alt="Sinbad2" style="height: 60px; margin-right: 20px;">
    <img src="logos/Uja.png" alt="Universidad de Ja√©n" style="height: 200px;">
</header>

<hr>

    <main class="container">
        <header>
            <nav>
                <ul>
                    <li><strong>üìù Generador de Ex√°menes Avanzado</strong></li>
                </ul>
                <ul>
                    <li><a href="#instrucciones-de-uso">Instrucciones</a></li>
                </ul>
            </nav>
        </header>

        <article>
            <p id="status" aria-busy="true" class="center">Cargando...</p>
            <div id="error-message" class="center hidden" style="color: red; margin-top: 1rem;">
                <p>Ha ocurrido un error al cargar los scripts. Por favor, intente recargar la p√°gina.</p>
                <button onclick="location.reload()">Recargar p√°gina</button>
            </div>

            <!-- Indicador de navegaci√≥n -->
            <div class="nav-indicator">
                <div class="nav-step active" id="step1-nav">1. Selecci√≥n de tipos</div>
                <div class="nav-step" id="step2-nav">2. Caracterizaci√≥n</div>
                <div class="nav-step" id="step3-nav">3. Generaci√≥n con IA</div>
                <div class="nav-step" id="step4-nav">4. Archivo de entrada</div>
            </div>

            <!-- Paso 1: Selecci√≥n de tipos de preguntas -->
            <div id="step1" class="step">
                <h3><span class="step-number">1</span>Selecci√≥n de tipos de preguntas</h3>
                <p>Seleccione los tipos de preguntas que desea incluir en su examen y la cantidad de cada tipo:</p>

                <div class="question-types-container">
                    <div class="question-type">
                        <label for="multirespuesta">Preguntas de opci√≥n m√∫ltiple:</label>
                        <input type="number" id="multirespuesta" name="multirespuesta" min="0" value="5">
                    </div>

                    <div class="question-type">
                        <label for="verdadero_falso">Preguntas de verdadero/falso:</label>
                        <input type="number" id="verdadero_falso" name="verdadero_falso" min="0" value="0">
                    </div>

                    <div class="question-type">
                        <label for="respuesta_corta">Preguntas de respuesta corta:</label>
                        <input type="number" id="respuesta_corta" name="respuesta_corta" min="0" value="0">
                    </div>

                    <div class="question-type">
                        <label for="rellenar_espacios">Preguntas de rellenar espacios:</label>
                        <input type="number" id="rellenar_espacios" name="rellenar_espacios" min="0" value="0">
                    </div>
                </div>

                <div class="navigation">
                    <div></div>
                    <button id="btn-to-step2">Siguiente</button>
                </div>
            </div>

            <!-- Paso 2: Caracterizaci√≥n del examen -->
            <div id="step2" class="step hidden">
                <h3><span class="step-number">2</span>Caracterizaci√≥n del examen</h3>
                <!-- Modificaci√≥n para la configuraci√≥n de multirespuesta -->
                <div id="multirespuesta-config" class="question-type hidden">
                    <h4>Configuraci√≥n para preguntas de opci√≥n m√∫ltiple</h4>
                    <label for="opciones_multirespuesta">N√∫mero de opciones por pregunta:</label>
                    <input type="number" id="opciones_multirespuesta" name="opciones_multirespuesta" min="2" value="4">

                    <fieldset>
                        <legend>¬øPenalizan las respuestas err√≥neas?</legend>
                        <label><input type="radio" name="penalizacion_multi" value="si" checked> S√≠</label>
                        <label><input type="radio" name="penalizacion_multi" value="no"> No</label>
                    </fieldset>

                    <div id="penalizacion_multi_config" class="penalizacion-config">
                        <label for="valor_penalizacion_multi">Valor de la penalizaci√≥n (porcentaje de la
                            puntuaci√≥n):</label>
                        <input type="number" id="valor_penalizacion_multi" name="valor_penalizacion_multi" min="0"
                            max="100" step="1" value="25">
                        <small>Porcentaje de la puntuaci√≥n total que se resta por cada respuesta incorrecta.</small>
                    </div>

                    <label for="puntos_multi">Puntos por respuesta correcta:</label>
                    <input type="number" id="puntos_multi" name="puntos_multi" min="0.1" step="0.1" value="1">
                </div>

                <div id="verdadero_falso-config" class="question-type hidden">
                    <h4>Configuraci√≥n para preguntas de verdadero/falso</h4>
                    <fieldset>
                        <legend>¬øPenalizan las respuestas err√≥neas?</legend>
                        <label><input type="radio" name="penalizacion_vf" value="si" checked> S√≠</label>
                        <label><input type="radio" name="penalizacion_vf" value="no"> No</label>
                    </fieldset>

                    <div id="penalizacion_vf_config" class="penalizacion-config">
                        <label for="valor_penalizacion_vf">Valor de la penalizaci√≥n (porcentaje de la
                            puntuaci√≥n):</label>
                        <input type="number" id="valor_penalizacion_vf" name="valor_penalizacion_vf" min="0" max="100"
                            step="1" value="50">
                        <small>Porcentaje de la puntuaci√≥n total que se resta por cada respuesta incorrecta.</small>
                    </div>

                    <label for="puntos_vf">Puntos por respuesta correcta:</label>
                    <input type="number" id="puntos_vf" name="puntos_vf" min="0.1" step="0.1" value="1">
                </div>

                <div id="respuesta_corta-config" class="question-type hidden">
                    <h4>Configuraci√≥n para preguntas de respuesta corta</h4>
                    <label for="puntos_corta">Puntos por respuesta correcta:</label>
                    <input type="number" id="puntos_corta" name="puntos_corta" min="0.1" step="0.1" value="1">

                    <fieldset>
                        <legend>¬øDistinguir may√∫sculas y min√∫sculas?</legend>
                        <label><input type="radio" name="case_sensitive" value="si"> S√≠</label>
                        <label><input type="radio" name="case_sensitive" value="no" checked> No</label>
                    </fieldset>
                </div>

                <div id="rellenar_espacios-config" class="question-type hidden">
                    <h4>Configuraci√≥n para preguntas de rellenar espacios</h4>
                    <label for="puntos_rellenar">Puntos por respuesta correcta:</label>
                    <input type="number" id="puntos_rellenar" name="puntos_rellenar" min="0.1" step="0.1" value="1">
                </div>

                <div class="navigation">
                    <button id="btn-to-step1-from-2" class="outline">Anterior</button>
                    <button id="btn-to-step3">Siguiente</button>
                </div>
            </div>

            <!-- Paso 3: Generaci√≥n de preguntas con IA -->
            <div id="step3" class="step hidden">
                <h3><span class="step-number">3</span>Generaci√≥n de preguntas con IA</h3>
                <p>Genere un prompt para crear preguntas utilizando IA. Puede definir un tema, nivel de dificultad o subir sus propios apuntes:</p>

                <div class="panel-tabs">
                    <div class="panel-tab active" data-panel="tema-panel">Por tema</div>
                    <div class="panel-tab" data-panel="apuntes-panel">Por apuntes</div>
                    <div class="panel-tab" data-panel="api-panel">Conexi√≥n IA (requiere clave)</div>
                </div>

                <div class="panel-content active" id="tema-panel">
                    <div class="grid">
                        <div>
                            <label for="tema">Tema o asignatura:</label>
                            <input type="text" id="tema" name="tema" placeholder="Ej. Historia de Espa√±a, Matem√°ticas, Biolog√≠a..." required>
                        </div>
                    </div>
                    
                    <div class="grid">
                        <div>
                            <label for="dificultad">Nivel de dificultad:</label>
                            <select id="dificultad" name="dificultad">
                                <option value="facil">F√°cil</option>
                                <option value="medio" selected>Medio</option>
                                <option value="dificil">Dif√≠cil</option>
                                <option value="muy_dificil">Muy dif√≠cil</option>
                            </select>
                        </div>
                        <div>
                            <fieldset>
                                <legend>Modo de generaci√≥n:</legend>
                                <label>
                                    <input type="radio" name="modo_generacion_tema" value="examenes_separados" checked>
                                    Ex√°menes separados
                                </label>
                                <label>
                                    <input type="radio" name="modo_generacion_tema" value="preguntas_adicionales">
                                    Banco de preguntas
                                </label>
                            </fieldset>
                        </div>
                    </div>
                
                    <div id="examenes-separados-tema" class="opciones-modo">
                        <div class="grid">
                            <div>
                                <label for="num_examenes">N√∫mero de ex√°menes distintos:</label>
                                <input type="number" id="num_examenes" name="num_examenes" min="1" value="1">
                                <small>Se generar√°n varios ex√°menes con el mismo n√∫mero de preguntas cada uno.</small>
                            </div>
                        </div>
                    </div>
                    
                    <div id="preguntas-adicionales-tema" class="opciones-modo hidden">
                        <div class="grid">
                            <div>
                                <p>Para cada tipo de pregunta, indica cu√°ntas preguntas <strong>adicionales</strong> deseas generar:</p>
            <small style="margin-bottom: 10px;">Estas se sumar√°n a las seleccionadas en el paso 1. Deja en 0 los tipos donde no quieras preguntas adicionales.</small>
                            </div>
                        </div>
                        
                        <div class="grid">
                            <div>
                                <label for="multi_adicionales_tema">Preguntas de opci√≥n m√∫ltiple:</label>
                                <input type="number" id="multi_adicionales_tema" min="0" value="5">
                            </div>
                            <div>
                                <label for="vf_adicionales_tema">Preguntas de verdadero/falso:</label>
                                <input type="number" id="vf_adicionales_tema" min="0" value="5">
                            </div>
                        </div>
                        
                        <div class="grid">
                            <div>
                                <label for="rc_adicionales_tema">Preguntas de respuesta corta:</label>
                                <input type="number" id="rc_adicionales_tema" min="0" value="5">
                            </div>
                            <div>
                                <label for="re_adicionales_tema">Preguntas de rellenar espacios:</label>
                                <input type="number" id="re_adicionales_tema" min="0" value="5">
                            </div>
                        </div>
                        <small>Se generar√° un solo archivo con todas las preguntas.</small>
                    </div>
                        
                    <div>
                        <label for="indicaciones-adicionales">Indicaciones adicionales (opcional):</label>
                        <textarea id="indicaciones-adicionales" name="indicaciones-adicionales" rows="3" 
                            placeholder="Incluya cualquier detalle adicional sobre el contenido, enfoque o nivel educativo de las preguntas."></textarea>
                    </div>
                </div>

                <div class="panel-content" id="apuntes-panel">
                    <h4>Prompt para preguntas basadas en apuntes</h4>
                    <p>Esta opci√≥n generar√° un prompt para crear preguntas a partir de apuntes o material did√°ctico que proporcionar√° directamente a la IA.</p>
                    
                    <div class="grid">
                      <div>
                          <fieldset>
                              <legend>Modo de generaci√≥n:</legend>
                              <label>
                                  <input type="radio" name="modo_generacion_apuntes" value="examenes_separados" checked>
                                  Ex√°menes separados
                              </label>
                              <label>
                                  <input type="radio" name="modo_generacion_apuntes" value="preguntas_adicionales">
                                  Banco de preguntas
                              </label>
                          </fieldset>
                      </div>
                    </div>
                  
                    <div id="examenes-separados-apuntes" class="opciones-modo">
                      <div class="grid">
                          <div>
                              <label for="num_examenes_apuntes">N√∫mero de ex√°menes distintos:</label>
                              <input type="number" id="num_examenes_apuntes" name="num_examenes_apuntes" min="1" value="1">
                              <small>Se generar√°n varios ex√°menes con el mismo n√∫mero de preguntas cada uno.</small>
                          </div>
                      </div>
                    </div>
                    
                    <div id="preguntas-adicionales-apuntes" class="opciones-modo hidden">
                      <div class="grid">
                          <div>
                            <p>Para cada tipo de pregunta, indica cu√°ntas preguntas <strong>adicionales</strong> deseas generar:</p>
            <small style="margin-bottom: 10px;">Estas se sumar√°n a las seleccionadas en el paso 1. Deja en 0 los tipos donde no quieras preguntas adicionales.</small>
                          </div>
                      </div>
                      
                      <div class="grid">
                          <div>
                              <label for="multi_adicionales_apuntes">Preguntas de opci√≥n m√∫ltiple:</label>
                              <input type="number" id="multi_adicionales_apuntes" min="0" value="5">
                          </div>
                          <div>
                              <label for="vf_adicionales_apuntes">Preguntas de verdadero/falso:</label>
                              <input type="number" id="vf_adicionales_apuntes" min="0" value="5">
                          </div>
                      </div>
                      
                      <div class="grid">
                          <div>
                              <label for="rc_adicionales_apuntes">Preguntas de respuesta corta:</label>
                              <input type="number" id="rc_adicionales_apuntes" min="0" value="5">
                          </div>
                          <div>
                              <label for="re_adicionales_apuntes">Preguntas de rellenar espacios:</label>
                              <input type="number" id="re_adicionales_apuntes" min="0" value="5">
                          </div>
                      </div>
                      <small>Se generar√° un solo archivo con todas las preguntas base m√°s las adicionales.</small>
                    </div>
                    
                    <div>
                      <label for="instrucciones-apuntes">Instrucciones adicionales (opcional):</label>
                      <textarea id="instrucciones-apuntes" rows="3" placeholder="A√±ada cualquier instrucci√≥n espec√≠fica para la generaci√≥n de preguntas (nivel educativo, enfoque, etc.)"></textarea>
                    </div>
                    
                    <div class="info-box" style="margin-top: 15px; padding: 10px; background-color: #f0f8ff; border-left: 3px solid #1095c1; border-radius: 4px;">
                      <h5 style="margin-top: 0;">¬øC√≥mo funciona?</h5>
                      <ol>
                        <li>Seleccione los tipos y cantidad de preguntas en el paso anterior.</li>
                        <li>Pulse en "Generar prompt para IA" para obtener un prompt especializado.</li>
                        <li>Copie el prompt generado y util√≠celo en su herramienta de IA favorita.</li>
                        <li>Proporcione sus apuntes a la IA junto con el prompt (puede copiar/pegar sus apuntes o adjuntar un archivo seg√∫n permita la herramienta).</li>
                        <li>Guarde el resultado como archivo .txt para usarlo en el siguiente paso.</li>
                      </ol>
                      <p><small>Esta opci√≥n es ideal para crear ex√°menes basados en material did√°ctico espec√≠fico.</small></p>
                    </div>
                </div>

                <div class="panel-content hidden" id="api-panel">
                    <h4>Generar preguntas con IA directamente</h4>
                    <p>Usa una clave de OpenAI para generar preguntas directamente desde esta aplicaci√≥n.</p>
                  
                    <label for="api-key">Clave API de OpenAI:</label>
                    <input type="password" id="api-key" placeholder="sk-..." style="width:100%;" />
                    <small>
  ¬øNo tienes clave? <a href="https://platform.openai.com/account/api-keys" target="_blank" style="color: black; font-weight: bold;">Cons√≠guela aqu√≠</a> (requiere cuenta gratuita).
</small>

                      
                  
                    <label for="modelo-ia">Modelo:</label>
                    <select id="modelo-ia">
                      <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                      <option value="gpt-4">GPT-4</option>
                    </select>
                  
                    <label for="tema-api">Tema o asignatura:</label>
                    <input type="text" id="tema-api" placeholder="Ej. Historia de Espa√±a, Matem√°ticas..." />
                  
                    <label for="dificultad-api">Nivel de dificultad:</label>
                    <select id="dificultad-api">
                      <option value="facil">F√°cil</option>
                      <option value="medio" selected>Medio</option>
                      <option value="dificil">Dif√≠cil</option>
                      <option value="muy_dificil">Muy dif√≠cil</option>
                    </select>
                  
                    <label for="archivo-apuntes">Subir archivo de apuntes (.txt o .pdf):</label>
                    <input type="file" id="archivo-apuntes" accept=".txt,.pdf">
                  
                    <button id="generar-desde-api" class="primary">Generar preguntas</button>
                  
                    <div id="resultado-api" style="margin-top: 15px;"></div>
                  </div>
                  

                <div class="grid">
                    <div>
                        <button id="generar-prompt" class="primary">Generar prompt para IA</button>
                    </div>
                </div>

                <div id="prompt-container" class="hidden" style="margin-top: 20px;">
                    <h4>Prompt generado:</h4>
                    <div id="prompt-output"></div>
                    <button id="copy-prompt" class="copy-button">Copiar al portapapeles</button>
                    <p><small>Copie este prompt y p√©guelo en su herramienta de IA preferida para generar las preguntas.</small></p>
                </div>

                <div class="navigation">
                    <button id="btn-to-step2-from-3" class="outline">Anterior</button>
                    <button id="btn-to-step4">Continuar a subida de archivo</button>
                </div>
            </div>

            <!-- Paso 4: Archivo de entrada y formato de salida -->
            <div id="step4" class="step hidden">
                <h3><span class="step-number">4</span>Archivo de entrada y formato de salida</h3>
                <p>Suba el archivo de texto con el contenido de su examen y seleccione el formato de salida:</p>

                <form id="exam-form" class="grid">
                    <div>
                        <label for="entrada">Examen de entrada:</label>
                        <input id="entrada" name="entrada" type="file" accept=".txt" required>
                        <small>Aseg√∫rese de que el archivo .txt contiene las preguntas separadas por l√≠neas en blanco y
                            las respuestas correctas marcadas con $$$.</small>
                    </div>

                    <div>
                        <fieldset>
                            <legend>Formato de salida:</legend>
                            <div>
                                <input type="radio" id="papel" name="script" value="papel.py" checked>
                                <label for="papel">Papel (.txt)</label>
                            </div>
                            <div>
                                <input type="radio" id="moodle" name="script" value="moodle.py">
                                <label for="moodle">Moodle (.xml)</label>
                            </div>
                        </fieldset>
                    </div>

                    <div>
                        <p></p>
                        <div class="navigation">
                            <button id="btn-to-step3-from-4" class="outline" type="button">Anterior</button>
                            <button type="submit">Generar examen</button>
                        </div>
                    </div>
                   
                    
                   
                </form>
                
            </div>

            <div id="preview-container" class="hidden" style="margin-top: 20px;">
                <h4>Vista previa del examen:</h4>
                <div id="preview-content" style="background: #f4f4f4; padding: 1em; border-radius: 6px;"></div>

                <button id="btn-guardar-txt" class="outline" style="margin-top: 20px;">üíæ Guardar como archivo .txt</button>

              </div>
              
              

        </article>

        <!-- Resto del contenido HTML -->
        <h2 id="instrucciones-de-uso">Instrucciones de uso</h2>
        <ol type="1">
            <li><strong>Seleccione los tipos de preguntas</strong> que desea incluir en su examen y la cantidad de cada
                tipo.</li>
            <li><strong>Configure las caracter√≠sticas</strong> de cada tipo de pregunta seleccionado (opciones,
                puntuaci√≥n, etc.)</li>
            <li><strong>Genere preguntas con IA</strong> definiendo un tema, nivel educativo, dificultad o subiendo sus propios apuntes.</li>
            <li><strong>Prepare el archivo de entrada</strong> con todas sus preguntas separadas por l√≠neas en blanco.
                La respuesta correcta debe estar marcada con "$$$" al inicio.</li>
            <li><strong>Suba el archivo</strong> y seleccione el formato de salida deseado (Papel o Moodle).</li>
            <li><strong>Descargue</strong> el examen generado.</li>
        </ol>

        <h4 id="ejemplo-de-ex√°men-de-entrada">Ejemplos de formato para diferentes tipos de preguntas</h4>

        <h5>Cabecera de variables (opcional)</h5>
        <pre><code>entero,x1,20,25
real,x2,0.3,0.4
lista,x3,2,4,6,8
@@@@</code></pre>

        <h5>Preguntas de opci√≥n m√∫ltiple</h5>
        <pre><code>¬øCu√°l es el cociente entre estos dos n√∫meros @@ x1 @@, @@ x3 @@ ?
$$$Dividirlos y da como resultado: @@ x1/x3 @@
Restarlos y da como resultado: @@ x1-x3 @@
Ninguna de las anteriores</code></pre>

        <h5>Preguntas de opci√≥n m√∫ltiple con enunciado multil√≠nea</h5>
        <pre><code>¬øEst√°s de acuerdo con estas afirmaciones?
- El doble de @@ x2 @@ es @@ x2*2 @@
- El triple de @@ x2 @@ es @@ x2*3 @@ 
+++p
$$$Con las dos
Con ninguna
Con la primera s√≠, con la segunda no, ser√≠a @@ x2*4 @@
Ninguna de las anteriores</code></pre>

        <h5>Preguntas de verdadero/falso</h5>
        <pre><code>La suma de @@ x1 @@ m√°s @@ x3 @@ es mayor que 30.
$$$Verdadero
Falso</code></pre>

        <h5>Preguntas de respuesta corta</h5>
        <pre><code>¬øCu√°l es el resultado de calcular @@ x1 @@ dividido entre @@ x3 @@? Escriba solo el n√∫mero.
$@@ x1/x3 @@</code></pre>

        <h5>Preguntas de rellenar espacios</h5>
        <pre><code>Complete la frase: La suma de @@ x1 @@ y @@ x3 @@ es _____.
$@@ x1+x3 @@</code></pre>

    </main>
    <script src="app.js"></script>
    <!-- Y a√±adir este script antes del cierre de body: -->
    <script>
        // A√±adir un timeout para mostrar un mensaje de error si la carga tarda demasiado
        setTimeout(function () {
            const statusEl = document.getElementById('status');
            const errorMessageEl = document.getElementById('error-message');

            // Si despu√©s de 10 segundos todav√≠a est√° cargando, mostrar mensaje de error
            if (!statusEl.hidden) {
                errorMessageEl.classList.remove('hidden');
            }
        }, 10000);
    </script>

<script>
    document.getElementById("generar-desde-api").addEventListener("click", async () => {
      const apiKey = document.getElementById("api-key").value.trim();
      const modelo = document.getElementById("modelo-ia").value;
      const tema = document.getElementById("tema-api").value.trim();
      const dificultad = document.getElementById("dificultad-api").value;
      const fileInput = document.getElementById("archivo-apuntes");
      const resultDiv = document.getElementById("resultado-api");
  
      if (!apiKey || !fileInput.files.length) {
        alert("Por favor sube un archivo de apuntes y proporciona una clave API.");
        return;
      }
  
      const file = fileInput.files[0];
      let fileText = "";
  
      if (file.name.endsWith(".pdf")) {
        const pdfjsLib = window['pdfjs-dist/build/pdf'];
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
        const pdf = await pdfjsLib.getDocument(URL.createObjectURL(file)).promise;
        for (let i = 1; i <= pdf.numPages; i++) {
          const page = await pdf.getPage(i);
          const textContent = await page.getTextContent();
          fileText += textContent.items.map(item => item.str).join(" ") + "\n";
        }
      } else {
        fileText = await file.text();
      }
  
      // Construir prompt din√°micamente
      let prompt = "Genera preguntas tipo test y verdadero/falso";
      if (tema) prompt += ` sobre el tema \"${tema}\"`;
      if (dificultad) prompt += ` con nivel \"${dificultad}\"`;
      prompt += ` usando los siguientes apuntes:\n\n${fileText}`;
  
      resultDiv.innerHTML = "<em>Generando...</em>";
  
      try {
        const respuesta = await fetch("https://api.openai.com/v1/chat/completions", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model: modelo,
            messages: [{ role: "user", content: prompt }],
            temperature: 0.7,
            max_tokens: 1200
          })
        });
  
        const data = await respuesta.json();
  
        if (respuesta.status === 429) {
          if (modelo === "gpt-4") {
            resultDiv.innerHTML = `<span style='color:red;'>Parece que tu cuenta no tiene acceso a GPT-4. Intenta usar GPT-3.5 o revisa tu cuenta en OpenAI.</span>`;
          } else {
            resultDiv.innerHTML = `<span style='color:red;'>L√≠mite de peticiones alcanzado o recursos temporales agotados. Intenta m√°s tarde.</span>`;
          }
        } else if (!respuesta.ok) {
          resultDiv.innerHTML = `<span style='color:red;'>Error ${respuesta.status}: ${data.error?.message || "Petici√≥n fallida."}</span>`;
        } else {
          resultDiv.innerHTML = `<pre>${data.choices?.[0]?.message?.content || "No se obtuvo respuesta."}</pre>`;
        }
  
      } catch (error) {
        resultDiv.innerHTML = `<span style='color:red;'>Error de red o inesperado: ${error.message}</span>`;
      }
    });
  </script>

<script>
    const imagenesAsignadas = {}; // clave: √≠ndice de pregunta, valor: archivo
  
    document.getElementById("entrada").addEventListener("change", async function () {
      const file = this.files[0];
      const previewContainer = document.getElementById("preview-container");
      const previewContent = document.getElementById("preview-content");
  
      if (!file || !file.name.endsWith(".txt")) {
        previewContainer.classList.add("hidden");
        previewContent.innerHTML = "";
        return;
      }
  
      const text = await file.text();
      const bloques = text.split(/\n\s*\n/); // separaci√≥n por l√≠nea en blanco
      const render = [];
  
      bloques.forEach((bloque, index) => {
        const lineas = bloque.trim().split("\n").map(l => l.trim());
        if (lineas.length === 0) return;
  
        const idPregunta = `pregunta-${index}`;
        let html = "";
        let tipo = "";
  
        if (lineas[1]?.startsWith("$$$") && lineas.length >= 3) {
          tipo = "Opci√≥n m√∫ltiple";
          const enunciado = lineas[0];
          const opciones = lineas.slice(1).map((op, i) => {
            const esCorrecta = op.startsWith("$$$");
            const texto = op.replace("$$$", "").trim();
            return `
              <li>
                <label>
                  <input type="radio" name="correcta-${index}" ${esCorrecta ? "checked" : ""}>
                  <input type="text" value="${texto}">
                </label>
              </li>`;
          });
  
          html = `
            <strong>${tipo}</strong><br>
            <input type="text" value="${enunciado}" style="width:100%; margin-bottom:5px;"><br>
            <ul>${opciones.join("")}</ul>
          `;
        } else if (lineas.length === 2 && (lineas[1].startsWith("$$$") || lineas[1] === "Verdadero" || lineas[1] === "Falso")) {
          tipo = "Verdadero/Falso";
          const enunciado = lineas[0];
          const respuesta = lineas[1].replace("$$$", "");
  
          html = `
            <strong>${tipo}</strong><br>
            <input type="text" value="${enunciado}" style="width:100%; margin-bottom:5px;"><br>
            <select>
              <option value="Verdadero" ${respuesta === "Verdadero" ? "selected" : ""}>Verdadero</option>
              <option value="Falso" ${respuesta === "Falso" ? "selected" : ""}>Falso</option>
            </select>
          `;
        } else if (lineas[1]?.startsWith("$")) {
          tipo = "Respuesta corta o rellenar espacios";
          html = `
            <strong>${tipo}</strong><br>
            <input type="text" value="${lineas[0]}" style="width:100%; margin-bottom:5px;"><br>
            <input type="text" value="${lineas[1].replace("$", "")}" style="width:100%;">
          `;
        } else {
          tipo = "Texto libre o formato no reconocido";
          html = `<strong>${tipo}</strong><pre>${bloque}</pre>`;
        }
  
        render.push(`
          <div id="${idPregunta}" style="margin-bottom: 1em; border-bottom: 1px solid #ccc; padding-bottom: 10px;">
            ${html}
            <div style="margin-top: 5px;">
              <button onclick="document.getElementById('img-${index}').click()">üì∑ Asignar imagen</button>
              <input type="file" id="img-${index}" accept="image/*" style="display:none" onchange="asignarImagen(event, ${index})">
              <div id="img-preview-${index}" style="margin-top:5px;"></div>
            </div>
            <button onclick="eliminarPregunta('${idPregunta}')">‚ùå Eliminar</button>
          </div>
        `);
      });
  
      previewContent.innerHTML = render.join("");
      previewContainer.classList.remove("hidden");
    });
  
    function eliminarPregunta(id) {
      const pregunta = document.getElementById(id);
      if (pregunta) {
        pregunta.remove();
      }
    }
  
    function asignarImagen(event, index) {
      const archivo = event.target.files[0];
      if (!archivo) return;
  
      imagenesAsignadas[index] = archivo;
  
      const reader = new FileReader();
      reader.onload = function (e) {
        const img = `<img src="${e.target.result}" alt="Imagen pregunta" style="max-width: 200px; display:block;">`;
        document.getElementById(`img-preview-${index}`).innerHTML = img;
      };
      reader.readAsDataURL(archivo);
    }
  </script>

<script>
    document.getElementById("btn-guardar-txt").addEventListener("click", () => {
      const preguntas = document.querySelectorAll("#preview-content > div");
      const lineas = [];
  
      preguntas.forEach((bloque, i) => {
        const strong = bloque.querySelector("strong");
        const tipo = strong?.textContent?.trim();
  
        if (tipo === "Opci√≥n m√∫ltiple") {
          const enunciado = bloque.querySelector("input[type='text']").value;
          lineas.push(enunciado);
  
          const opciones = bloque.querySelectorAll("ul li");
          opciones.forEach(li => {
            const inputRadio = li.querySelector("input[type='radio']");
            const inputTexto = li.querySelector("input[type='text']");
            const texto = inputTexto.value.trim();
            const linea = inputRadio.checked ? `$$$${texto}` : texto;
            lineas.push(linea);
          });
        }
  
        else if (tipo === "Verdadero/Falso") {
          const enunciado = bloque.querySelector("input[type='text']").value;
          const seleccion = bloque.querySelector("select").value;
          lineas.push(enunciado);
          lineas.push(`$$$${seleccion}`);
        }
  
        else if (tipo === "Respuesta corta o rellenar espacios") {
          const enunciado = bloque.querySelectorAll("input[type='text']")[0].value;
          const respuesta = bloque.querySelectorAll("input[type='text']")[1].value;
          lineas.push(enunciado);
          lineas.push(`$${respuesta}`);
        }
  
        else {
          // tipo libre
          lineas.push(bloque.textContent.trim());
        }
  
        lineas.push(""); // separador entre preguntas
      });
  
      const textoFinal = lineas.join("\n");
      const blob = new Blob([textoFinal], { type: "text/plain" });
      const url = URL.createObjectURL(blob);
      const enlace = document.createElement("a");
      enlace.href = url;
      enlace.download = "examen_editado.txt";
      enlace.click();
      URL.revokeObjectURL(url);
    });
  </script>
  
  
<hr>
<footer style="text-align: center; padding: 20px; font-size: 1rem; color: #ffffff; font-weight: 500; text-shadow: 0 1px 2px rgba(0,0,0,0.4);">

    <p>¬© 2025 Juan Diego Rodr√≠guez Cabrero</p>
    <p>Contacto: <a href="mailto:jdrodriguezcabrero@hotmail.com">jdrodriguezcabrero@hotmail.com</a></p>
    <p>Este sitio forma parte del proyecto educativo desarrollado en colaboraci√≥n con I.E.S. Oretania, Universidad de Ja√©n y Sinbad¬≤.</p>
</footer>

</body>

</html>